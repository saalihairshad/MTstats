
```{r}
library(mongolite)
library(tidyverse)
library(dplyr)
library(irr)
library(jsonlite)
library(ggpubr)
library(stringi)
library(qdap)
library(cld2)
library(plyr)
library(e1071)
library(xlsx)
library(PMCMRplus)
library(knitr)
library(lubridate)
library(reshape2)
library(rmarkdown)
library(tinytex)
```


```{r}
options(max.print = 99999)

#import MongoDB collection into R
db <- mongo(
  collection = "final1",
  db = "analysis",
  url = "mongodb://localhost:27017/",
  verbose = FALSE,
  options = ssl_options()
)

#count observations
db$count()

# put environment into proper dataset - makes it easy to get an overview of nested table
df <- db$find('{}')

#take a quick look into the dataset
#glimpse(df)

# Flatten table
datacomplete <- df %>% flatten()


#Remove noise
datacomplete1<-datacomplete[!(datacomplete$finalannotationcontentcategory=="Noise"),]


# select only important columns from full dataset and save into a new data frame
# my_data <- as_tibble(datacomplete)
final_data <- datacomplete1 %>% select(app_name, country_code, country, content_category = finalannotationcontentcategory, sentiment = finalannotationsentiment, gender = finalannotationgender, created_at, text = full_text)

final_data

```



### Obtain month-year from the original date
```{r}


tweets_date <- as.POSIXct(final_data$created_at, format = "%a %b %e %T %z %Y")
## Index each tweet by the day of its creation
new_date = cut(tweets_date, breaks = "day")

## Get the month and year
final_data$new_date <- new_date
final_data$new_date = as.Date(final_data$new_date, "%Y-%m-%d")
final_data$month_year = format(as.Date(final_data$new_date), "%b-%Y")

```

### Get date, country and app 
```{r}
data <- data.frame(final_data$month_year, final_data$country, final_data$app_name)
colnames(data)<- c("date", "country", "app")
data
```



### Get country count w.r.t date
```{r}
data_country <- data %>% group_by(date, country) %>%
 add_count(date)

data_country <-  data_country %>% distinct()
data_country

```


### Plot the tweets collected per month per country
```{r}
#png(height=1200, width=1200, pointsize=50, file="country.png")
#tiff("test.tiff", units="in", width=5, height=5, res=300)
ggplot(data_country, aes(reorder(date, n), y = n, fill=country)) +
  geom_col(position = "dodge", alpha = 0.9) +
  theme_bw() +
  theme(axis.text.x=element_text(angle = -90, hjust = 0)) +
  xlab("Period") +
  ylab("Tweet Count") +
  labs(title = "Tweets collected per coutry per month") +
  scale_fill_manual(values = alpha(c("#dd3497", "#66c2a4", "#9970ab", "#76BFF1", "#ffdb58", "#f46d43", "#bf812d", "#fba0e3" ), .4))
  #theme_minimal()
  #expand_limits(x = 4, y = 0)
  # facet_wrap(. ~country, nrow = 3)
```

```{r}
data_country
```



## Get country count w.r.t date
```{r}
data_app <- data %>% group_by(date, app) %>%
 add_count(date)

data_app <-  data_app %>% distinct()
data_app

```


```{r}
# x <- data_app %>% filter(app == "AdobeCare" && date=="Apr-2020")
# x
# sum(x$n)
```


### Plot the tweets collected per month per app
```{r}
#png(height=1200, width=1200, pointsize=50, file="country.png")
#tiff("test.tiff", units="in", width=5, height=5, res=300)
ggplot(data_app, aes(reorder(date, n), y = n, fill=app)) +
  geom_col(position = "dodge", alpha = 0.9) +
  theme_bw() +
  theme(axis.text.x=element_text(angle = -90, hjust = 0)) +
  xlab("Period") +
  ylab("Tweet Count") +
  labs(title = "Tweets collected per app per month") +
  scale_fill_manual(values = alpha(c("#dd3497", "#66c2a4", "#9970ab", "#76BFF1", "#ffdb58", "#f46d43", "#bf812d", "#fba0e3", "#ccebc5", "#fcbba1" ), .4))
  #theme_minimal()
  #expand_limits(x = 4, y = 0)
  # facet_wrap(. ~country, nrow = 3)
```




## Get the count per month per app per country

```{r}
data_all <- data
data_all <- data_all %>% group_by(date, country, app) %>%
  add_count(date)

data_all <-  data_all %>% distinct()

data_all
```

## Plot tweet count per app per month per country
```{r}

# New facet label names for dose variable
app.labs <- c("Adobe", "Dropbox", "Evernote", "Googlemaps", "Linkedin", "Nexflix", "Slack", "Snapchat","Spotify","Youtube")
names(app.labs) <- c("AdobeCare", "DropboxSupport", "evernotehelps", "googlemaps", "LinkedInHelp", "Netflixhelps", "SlackHQ", "snapchatsupport","SpotifyCares","TeamYouTube")

# New facet label names for supp variable
country.labs <- c("AU", "CA", "FR","DE","IN", "NL", "GB", "US")
names(country.labs) <- c("Australia", "Canada", "France", "Germany", "India", "Netherlands", "United Kingdom", "United States")


ggplot(data_all, aes(reorder(date, n), y = n)) +
  geom_col(position = "dodge", width=1) +
  theme_bw() +
  theme(axis.text.x=element_text(angle = -90, hjust = 0))+
  xlab("Period") +
  ylab("Tweet Count") +
  scale_fill_manual(values = alpha(c("#fbb4b9", "#fdcdac", "#a6cee3", "#76BFF1", "#bf812d", "#f46d43", "#9970ab", "#969696" ), .8)) +
  facet_grid(country ~ app, space="free", scales="free", 
             labeller = labeller(app = app.labs, country = country.labs))+
  theme(
      strip.text.x = element_text(
        size = 6
        ),
      strip.text.y = element_text(
        size = 6
        ),
        strip.background = element_rect(
       color="black", fill="#fcbba1"
       )
      )
```



## Merge country and app and get the count w.r.t date
```{r}
df <- data %>% group_by(date, country, app) %>%
  add_count(date)

df <-  df %>% distinct()
df <- df %>% unite(country_app, c(country, app))


df
```


```{r}
library(rcompanion)
model <- lm(n ~ country_app, df)

x = residuals(model)
plotNormalHistogram(x)
qqnorm(residuals(model), ylab="Sample Quantiles for residuals")
qqline(residuals(model), col="red")
plot(fitted(model), residuals(model))
shapiro.test(residuals(model))
```

## Both plots below are not useful - too many distinict combinitions of app and countries

```{r}
ggplot(df, aes(x = date, y = n)) +
  geom_col(position = "dodge") +
  theme_bw() +
  theme(axis.text.x=element_text(angle = -90, hjust = 0))+
  facet_wrap(. ~country_app, nrow = 6)
```


```{r}
p <- ggplot(df, aes(reorder(date,n), y = n, fill=country_app)) +
  geom_col(position = "dodge", alpha = 0.9) +
  theme_bw() +
  theme(axis.text.x=element_text(angle = -90, hjust = 0)) +
  xlab("Period") +
  ylab("Tweet Count") +
  labs(title = "Tweets count per app_coutry per month")

p <-  p + guides(shape = guide_legend(override.aes = list(size = 0.5)))
p <- p + guides(color = guide_legend(override.aes = list(size =  0.5)))
p <- p + theme(legend.title = element_text(size = 3),
               legend.text = element_text(size = 3))

p
# addSmallLegend <- function(myPlot, pointSize = 0.5, textSize = 8, spaceLegend = 0.1) {
#     myPlot +
#         guides(shape = guide_legend(override.aes = list(size = pointSize)),
#                color = guide_legend(override.aes = list(size = pointSize))) +
#         theme(legend.title = element_text(size = textSize), 
#               legend.text  = element_text(size = textSize),
#               legend.key.size = unit(spaceLegend, "lines"))
# }
# 
# # Apply on original plot
# addSmallLegend(p)

```




















