```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(mongolite)
library(tidyverse)
library(dplyr)
library(irr)
library(jsonlite)
library(ggpubr)
library(stringi)
library(qdap)
library(cld2)
library(plyr)
library(e1071)
library(xlsx)
library(PMCMRplus)
```

```{r}
#import MongoDB collection into R
db <- mongo(
  collection = "final1",
  db = "analysis",
  url = "mongodb://localhost:27017/",
  verbose = FALSE,
  options = ssl_options()
)

#count observations
db$count()
```

```{r}
# put environment into proper dataset - makes it easy to get an overview of nested table
df <- db$find('{}')

#take a quick look into the dataset
#glimpse(df)

# Flatten table
datacomplete <- df %>% flatten()


#Remove noise
datacomplete1<-datacomplete[!(datacomplete$finalannotationcontentcategory=="Noise"),]


# select only important columns from full dataset and save into a new data frame
# my_data <- as_tibble(datacomplete)
final_data <- datacomplete1 %>% select(app_name, country_code, country, content_category = finalannotationcontentcategory, sentiment = finalannotationsentiment, gender = finalannotationgender)

final_data
```


###Prepare cultural groups with low and high### 
```{r}
final_data_culture <- final_data

final_data_culture$culturegroup <- NA
final_data_culture$PD <- NA
final_data_culture$IDVI <- NA
final_data_culture$MA <- NA
final_data_culture$UA <- NA
final_data_culture$LTO <- NA
final_data_culture$INDU <- NA
i=0

for (i in 1:(nrow(final_data_culture))) {
  if (final_data_culture$country_code[i] == "AU") {
    final_data_culture$PD[i] <- "low"
    final_data_culture$IDVI[i] <- "high"
    final_data_culture$MA[i] <- "high"
    final_data_culture$UA[i] <- "high"
    final_data_culture$LTO[i] <- "low"
    final_data_culture$INDU[i] <- "high"
    
  } else if (final_data_culture$country_code[i] == "CA" ) {
    final_data_culture$PD[i] <- "low"
    final_data_culture$IDVI[i] <- "high"
    final_data_culture$MA[i] <- "high"
    final_data_culture$UA[i] <- "low"
    final_data_culture$LTO[i] <- "low"
    final_data_culture$INDU[i] <- "high"

  } else if (final_data_culture$country_code[i]== "FR" ) {
    final_data_culture$PD[i] <- "high"
    final_data_culture$IDVI[i] <- "high"
    final_data_culture$MA[i] <- "low"
    final_data_culture$UA[i] <- "high"
    final_data_culture$LTO[i] <- "high"
    final_data_culture$INDU[i] <- "low"

  } else if (final_data_culture$country_code[i] == "DE" ) {
    final_data_culture$PD[i] <- "low"
    final_data_culture$IDVI[i] <- "high"
    final_data_culture$MA[i] <- "high"
    final_data_culture$UA[i] <- "high"
    final_data_culture$LTO[i] <- "high"
    final_data_culture$INDU[i] <- "low"

  } else if (final_data_culture$country_code[i] == "IN" ) {
    final_data_culture$PD[i] <- "high"
    final_data_culture$IDVI[i] <- "low"
    final_data_culture$MA[i] <- "high"
    final_data_culture$UA[i] <- "low"
    final_data_culture$LTO[i] <- "high"
    final_data_culture$INDU[i] <- "low"

  }  else if (final_data_culture$country_code[i] == "NL" ) {
    final_data_culture$PD[i] <- "low"
    final_data_culture$IDVI[i] <- "high"
    final_data_culture$MA[i] <- "low"
    final_data_culture$UA[i] <- "high"
    final_data_culture$LTO[i] <- "high"
    final_data_culture$INDU[i] <- "high"

  }  else if (final_data_culture$country_code[i] == "GB" ) {
    final_data_culture$PD[i] <- "low"
    final_data_culture$IDVI[i] <- "high"
    final_data_culture$MA[i] <- "high"
    final_data_culture$UA[i] <- "low"
    final_data_culture$LTO[i] <- "high"
    final_data_culture$INDU[i] <- "high"

    
  } else if (final_data_culture$country_code[i] == "US" ) {
    final_data_culture$PD[i] <- "low"
    final_data_culture$IDVI[i] <- "high"
    final_data_culture$MA[i] <- "high"
    final_data_culture$UA[i] <- "low"
    final_data_culture$LTO[i] <- "low"
    final_data_culture$INDU[i] <- "high"

  } 
}

df_culture1 <- data.frame(final_data_culture$country_code, final_data_culture$PD, final_data_culture$IDVI, final_data_culture$MA, final_data_culture$UA, final_data_culture$LTO, final_data_culture$INDU)

colnames(df_culture1) <- c("country", "PD", "IDVI", "MA", "UA", "LTO", "INDU")
df_culture1
```

###Prepare cultural groups with original scores### 
```{r}
final_data_culture$PD1 <- NA
final_data_culture$IDVI1 <- NA
final_data_culture$MA1 <- NA
final_data_culture$UA1 <- NA
final_data_culture$LTO1 <- NA
final_data_culture$INDU1 <- NA
i=0

for (i in 1:(nrow(final_data_culture))) {
  if (final_data_culture[i,2] == "AU") {
    final_data_culture$PD1[i] <- 38
    final_data_culture$IDVI1[i] <- 90
    final_data_culture$MA1[i] <- 61
    final_data_culture$UA1[i] <- 51
    final_data_culture$LTO1[i] <- 21
    final_data_culture$INDU1[i] <- 71
    
  } else if (final_data_culture[i,2] == "CA" ) {
    final_data_culture$PD1[i] <- 39
    final_data_culture$IDVI1[i] <- 80
    final_data_culture$MA1[i] <- 52
    final_data_culture$UA1[i] <- 48
    final_data_culture$LTO1[i] <- 36
    final_data_culture$INDU1[i] <- 68

  } else if (final_data_culture[i,2] == "FR" ) {
     final_data_culture$PD1[i] <- 68
    final_data_culture$IDVI1[i] <- 71
    final_data_culture$MA1[i] <- 43
    final_data_culture$UA1[i] <- 86
    final_data_culture$LTO1[i] <- 63
    final_data_culture$INDU1[i] <- 48

  } else if (final_data_culture[i,2] == "DE" ) {
     final_data_culture$PD1[i] <- 35
    final_data_culture$IDVI1[i] <- 67
    final_data_culture$MA1[i] <- 66
    final_data_culture$UA1[i] <- 65
    final_data_culture$LTO1[i] <- 83
    final_data_culture$INDU1[i] <- 40

  } else if (final_data_culture[i,2] == "IN" ) {
    final_data_culture$PD1[i] <- 77
    final_data_culture$IDVI1[i] <- 48
    final_data_culture$MA1[i] <- 56
    final_data_culture$UA1[i] <- 40
    final_data_culture$LTO1[i] <- 51
    final_data_culture$INDU1[i] <- 26

  }  else if (final_data_culture[i,2] == "NL" ) {
    final_data_culture$PD1[i] <- 38
    final_data_culture$IDVI1[i] <- 80
    final_data_culture$MA1[i] <- 14
    final_data_culture$UA1[i] <- 53
    final_data_culture$LTO1[i] <- 67
    final_data_culture$INDU1[i] <- 68

  }  else if (final_data_culture[i,2] == "GB" ) {
    final_data_culture$PD1[i] <- 35
    final_data_culture$IDVI1[i] <- 89 
    final_data_culture$MA1[i] <- 66
    final_data_culture$UA1[i] <- 35
    final_data_culture$LTO1[i] <- 51
    final_data_culture$INDU1[i] <- 69

    
  } else if (final_data_culture[i,2]== "US" ) {
    final_data_culture$PD1[i] <- 40
    final_data_culture$IDVI1[i] <- 91
    final_data_culture$MA1[i] <- 62
    final_data_culture$UA1[i] <- 46
    final_data_culture$LTO1[i] <- 26
    final_data_culture$INDU1[i] <- 68
  } 
}

# df_culture2 <- data.frame(final_data_culture$country_code, final_data_culture$PD1, final_data_culture$IDVI1, final_data_culture$MA1, final_data_culture$UA1, final_data_culture$LTO1, final_data_culture$INDU1)
# 
# colnames(df_culture2) <- c("country", "PD", "IDVI", "MA", "UA", "LTO", "INDU")
# df_culture2


```

###Prepare cultural groups with 0 and 1 instead of low and high### 
```{r}

final_data_culture$PD3 <- NA
final_data_culture$IDVI3 <- NA
final_data_culture$MA3 <- NA
final_data_culture$UA3 <- NA
final_data_culture$LTO3 <- NA
final_data_culture$INDU3 <- NA
i=0

for (i in 1:(nrow(final_data_culture))) {
  if (final_data_culture$country_code[i] == "AU") {
    final_data_culture$PD3[i] <- 0
    final_data_culture$IDVI3[i] <- 1
    final_data_culture$MA3[i] <- 1
    final_data_culture$UA3[i] <- 1
    final_data_culture$LTO3[i] <- 0
    final_data_culture$INDU3[i] <- 1
    
  } else if (final_data_culture$country_code[i] == "CA" ) {
    final_data_culture$PD3[i] <- 0
    final_data_culture$IDVI3[i] <- 1
    final_data_culture$MA3[i] <- 1
    final_data_culture$UA3[i] <- 0
    final_data_culture$LTO3[i] <- 0
    final_data_culture$INDU3[i] <- 1

  } else if (final_data_culture$country_code[i]== "FR" ) {
    final_data_culture$PD3[i] <- 1
    final_data_culture$IDVI3[i] <- 1
    final_data_culture$MA3[i] <- 0
    final_data_culture$UA3[i] <- 1
    final_data_culture$LTO3[i] <- 1
    final_data_culture$INDU3[i] <- 0

  } else if (final_data_culture$country_code[i] == "DE" ) {
    final_data_culture$PD3[i] <- 0
    final_data_culture$IDVI3[i] <- 1
    final_data_culture$MA3[i] <- 1
    final_data_culture$UA3[i] <- 1
    final_data_culture$LTO3[i] <- 1
    final_data_culture$INDU3[i] <- 0

  } else if (final_data_culture$country_code[i] == "IN" ) {
    final_data_culture$PD3[i] <- 1
    final_data_culture$IDVI3[i] <- 0
    final_data_culture$MA3[i] <- 1
    final_data_culture$UA3[i] <- 0
    final_data_culture$LTO3[i] <- 1
    final_data_culture$INDU3[i] <- 0

  }  else if (final_data_culture$country_code[i] == "NL" ) {
    final_data_culture$PD3[i] <- 0
    final_data_culture$IDVI3[i] <- 1
    final_data_culture$MA3[i] <- 0
    final_data_culture$UA3[i] <- 1
    final_data_culture$LTO3[i] <- 1
    final_data_culture$INDU3[i] <- 1

  }  else if (final_data_culture$country_code[i] == "GB" ) {
    final_data_culture$PD3[i] <- 0
    final_data_culture$IDVI3[i] <- 1
    final_data_culture$MA3[i] <- 1
    final_data_culture$UA3[i] <- 0
    final_data_culture$LTO3[i] <- 1
    final_data_culture$INDU3[i] <- 1

    
  } else if (final_data_culture$country_code[i] == "US" ) {
    final_data_culture$PD3[i] <- 0
    final_data_culture$IDVI3[i] <- 1
    final_data_culture$MA3[i] <- 1
    final_data_culture$UA3[i] <- 0
    final_data_culture$LTO3[i] <- 0
    final_data_culture$INDU3[i] <- 1

  } 
}

# df_culture1 <- data.frame(final_data_culture$country_code, final_data_culture$PD3, final_data_culture$IDVI3, final_data_culture$MA3, final_data_culture$UA3, final_data_culture$LTO3, final_data_culture$INDU3)
# 
# colnames(df_culture1) <- c("country", "PD", "IDVI", "MA", "UA", "LTO", "INDU")
# df_culture1
final_data_culture
```


```{r}
final_data_culture$culturegroup <- NULL
culture_labels <- final_data_culture
culture_ranks <- final_data_culture
```

### Conver sentiment to labels ###
```{r}
j=0

for (j in 1:(nrow(culture_labels))) {
  if(culture_labels[j, 5] == -2) {
    culture_labels[j, 5]<- "VeryNegative"
  } else if (culture_labels[j, 5] == -1) {
    culture_labels[j, 5]<- "Negative"
  } else if (culture_labels[j, 5] == 0) {
    culture_labels[j, 5]<- "Neutral"
  } else if (culture_labels[j, 5] == 1) {
    culture_labels[j, 5]<- "Positive"
  } else
    culture_labels[j, 5]<- "VeryPositive"
}

culture_labels
```


```{r}
# Useful content


culture_ranks$usefulcontent_br_fr<- NA
i=0

for (i in 1:(nrow(culture_ranks))) {
  if (culture_ranks$content_category[i] == "SupportRequest") {
    culture_ranks$usefulcontent_br_fr[i] = 0
  } else if (culture_ranks$content_category[i] == "BugReport") {
    culture_ranks$usefulcontent_br_fr[i] = 1
  } else if (culture_ranks$content_category[i] == "FeatureRequest") {
    culture_ranks$usefulcontent_br_fr[i] = 1
  } else if (culture_ranks$content_category[i] == "Other") {
    culture_ranks$usefulcontent_br_fr[i] = 0
  }
}

culture_ranks$usefulcontent_br_fr_sr<- NA
i=0

for (i in 1:(nrow(culture_ranks))) {
  if (culture_ranks$content_category[i] == "SupportRequest") {
    culture_ranks$usefulcontent_br_fr_sr[i] = 1
  } else if (culture_ranks$content_category[i] == "BugReport") {
    culture_ranks$usefulcontent_br_fr_sr[i] = 1
  } else if (culture_ranks$content_category[i] == "FeatureRequest") {
    culture_ranks$usefulcontent_br_fr_sr[i] = 1
  } else if (culture_ranks$content_category[i] == "Other") {
    culture_ranks$usefulcontent_br_fr_sr[i] = 0
  }
}


k=0


for (k in 1:(nrow(culture_ranks))) {
  if(culture_ranks[k, 6] == "female") {
    culture_ranks[k, 6]<- 0
  } else if (culture_ranks[k, 6] == "male") {
    culture_ranks[k, 6]<- 1
  } else
    culture_ranks[k, 6]<- 2
}

culture_ranks$gender <- as.double(culture_ranks$gender)
culture_ranks

```


### ================================================================================================================== ###
# Spearman Correlation Test for SENTIMENT and CULTURAL DIMENSIONS (both variables are ordinal data)
# x (0 and 1)
# y (-2 to 2) 
### ================================================================================================================== ###
```{r}
options(scipen=9999)
cor.test(culture_ranks$PD3, culture_ranks$sentiment, method = "spearman", exact=FALSE)
cor.test(culture_ranks$IDVI3, culture_ranks$sentiment, method = "spearman", exact=FALSE)
cor.test(culture_ranks$UA3, culture_ranks$sentiment, method = "spearman", exact=FALSE)
cor.test(culture_ranks$LTO3, culture_ranks$sentiment, method = "spearman", exact=FALSE)
cor.test(culture_ranks$INDU3, culture_ranks$sentiment, method = "spearman", exact=FALSE)
```


### ================================================================================================================== ###
# Kendall Correlation Test for SENTIMENT and CULTURAL DIMENSIONS (both variables are ordinal data)
# x (0 and 1)
# y (-2 to 2) 
### ================================================================================================================== ###
```{r}
cor.test(culture_ranks$PD3, culture_ranks$sentiment, method = "kendall")
cor.test(culture_ranks$IDVI3, culture_ranks$sentiment, method = "kendall")
cor.test(culture_ranks$UA3, culture_ranks$sentiment, method = "kendall")
cor.test(culture_ranks$LTO3, culture_ranks$sentiment, method = "kendall")
cor.test(culture_ranks$INDU3, culture_ranks$sentiment, method = "kendall")
```


### ================================================================================================================== ###
# Pearson Correlation Test for SENTIMENT and CULTURAL DIMENSIONS
# x (0 and 1)
# y (-2 to 2) 
# both variables are ordinal data) but pearson treats them as interval so not sure if its a good idea to us this test
### ================================================================================================================== ###
```{r}
cor.test(culture_ranks$PD1, culture_ranks$sentiment, method = "pearson")
cor.test(culture_ranks$IDVI1, culture_ranks$sentiment, method = "pearson")
cor.test(culture_ranks$UA1, culture_ranks$sentiment, method = "pearson")
cor.test(culture_ranks$LTO1, culture_ranks$sentiment, method = "pearson")
cor.test(culture_ranks$INDU1, culture_ranks$sentiment, method = "pearson")
```



### Cramer's V for sentiment ###
```{r}
#senti_tb <- table(culture_ranks$sentiment, culture_ranks$INDU3)
senti_tb <- table(culture_labels$sentiment, culture_labels$INDU)
senti_tb

chisq.test(senti_tb)

library(lsr)
cramersV(senti_tb)
```


#---------------------------------------------------------------------------------------------------------------------------


### ================================================================================================================== ###
# Spearman Correlation Test for Content and CULTURAL DIMENSIONS (both variables are ordinal data)
# x (0 and 1)
# y (0 to 1) usefulcontent_br_fr
### ================================================================================================================== ###
```{r}
cor.test(culture_ranks$PD3, culture_ranks$usefulcontent_br_fr, method = "spearman", exact=FALSE)
cor.test(culture_ranks$IDVI3, culture_ranks$usefulcontent_br_fr, method = "spearman", exact=FALSE)
cor.test(culture_ranks$UA3, culture_ranks$usefulcontent_br_fr, method = "spearman", exact=FALSE)
cor.test(culture_ranks$LTO3, culture_ranks$usefulcontent_br_fr, method = "spearman", exact=FALSE)
cor.test(culture_ranks$INDU3, culture_ranks$usefulcontent_br_fr, method = "spearman", exact=FALSE)
```

### ================================================================================================================== ###
# Spearman Correlation Test for Content and CULTURAL DIMENSIONS (both variables are ordinal data)
# x (0 and 1)
# y (0 to 1) usefulcontent_br_fr_sr
### ================================================================================================================== ###
```{r}
cor.test(culture_ranks$PD3, culture_ranks$usefulcontent_br_fr_sr, method = "spearman", exact=FALSE)
cor.test(culture_ranks$IDVI3, culture_ranks$usefulcontent_br_fr_sr, method = "spearman", exact=FALSE)
cor.test(culture_ranks$UA3, culture_ranks$usefulcontent_br_fr_sr, method = "spearman", exact=FALSE)
cor.test(culture_ranks$LTO3, culture_ranks$usefulcontent_br_fr_sr, method = "spearman", exact=FALSE)
cor.test(culture_ranks$INDU3, culture_ranks$usefulcontent_br_fr_sr, method = "spearman", exact=FALSE)
```

### Cramer's V for content ###
```{r}

content_tb <- table(culture_ranks$content_category, culture_labels$INDU)
content_tb

chisq.test(content_tb)

library(lsr)
cramersV(content_tb)
```


### cohen's w ###
```{r}
library(DescTools)
content_tb1 <- table(culture_ranks$content_category, culture_ranks$PD)
content_tb1

library(rcompanion)

cohenW(content_tb1)
```







